var express = require('express');  //Express frameork object
var morgan = require('morgan');  //Morgan Framework object
var path = require('path');
var pg=require('pg');
var serveStatic = require('serve-static');
var app = express();
app.use(morgan('combined'));

var mysql=require("mysql");


var con = mysql.createConnection({
	host: 	  '127.0.0.1',
	user:	  'root',
	password: 'amay1996',
	database:  'test'
});

con.connect(function(err){
	if(err) {
	 console.log('Error connecting to DB');
	 console.log(err.stack);
	 return;
	}
	console.log('Connection Succesfull');
});


app.get('/test-db',function(req,res) {
	con.query('SELECT * FROM users',							//query test
	function(err,rows) { if(err) console.log(err.stack);
			     else
			     {console.log('Data recieved');console.log(rows);return rows;}
});//query test ends
//	res.send("Sucessfully out of query");
});//app.get ends


app.get('/toggle_status/:user_id',function(req,res) {
	var id = req.params.user_id;
	console.log('Entered app.get');
	con.query('SELECT status FROM status_table WHERE user_id =?',id,			//query 1
	function(err,rows) { if(err) console.log(err.stack); 
			     else if(rows[0].status==1)
		    	     {con.query('UPDATE status_table SET status=0 WHERE user_id=?',id,function(err,rows) {if(err) 								    	     console.log(err.stack);else return 1; return 0;});}
			     else if(rows[0].status==0)
			     {con.query('UPDATE status_table SET status=1 WHERE user_id=?',id,function(err,rows) {if(err) 								    	     console.log(err.stack);else return 1; return 0;});}
});//con.query 1 ends
});//app.get ends


app.get('/position/:id',function(req,res) {
	var id = req.params.id;
	con.query('SELECT * FROM position WHERE user_id=?',[id],					//query 2
	function(err,rows){ if(err) console.log(err.stack);
			    else return rows;
});//con.query 2 ends
});//app.get ends


app.get('/get-list1/:id',function(req,res){							//list1 is the list of people who have permission to track :id
	var id = req.params.id;
	con.query('SELECT * FROM permission WHERE user_id=?',[id],				//query 3
	function(err,rows){ if(err) console.log(err.stack);
//			    else return rows;
			    res.send(JSON.stringify(rows));
});//con.query 3 ends
});


app.get('/', function (req, res) {
  res.send("Hello");
});



var port = 80;// Use 8080 for local development because you might already have apache //running on 80
app.listen(port, function () {
  console.log(`IMAD course app listening on port ${port}!`);
});
